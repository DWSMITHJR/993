<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer - Local & Production</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pdf-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        .error-message {
            color: #d32f2f;
            background-color: #fde7e7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-style: italic;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #1565c0;
        }
        button:disabled {
            background-color: #90caf9;
            cursor: not-allowed;
        }
        .page-info {
            margin: 10px 0;
            color: #666;
            font-size: 0.9em;
        }
    </style>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <h1>PDF Viewer</h1>
    <p>This viewer works in both local file system and web server environments.</p>
    
    <div class="test">
        <h2>PDF.js Viewer</h2>
        <div class="controls">
            <button id="prev-page" disabled>Previous</button>
            <button id="next-page" disabled>Next</button>
            <span class="page-info">Page: <span id="page-num">-</span> / <span id="page-count">-</span></span>
        </div>
        <div class="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <div id="loading" class="loading">Loading PDF...</div>
            <div id="error" class="error-message" style="display: none;"></div>
        </div>
        <p>If the PDF doesn't load, try <a href="images/inside/window.pdf" target="_blank" id="direct-link">opening it directly</a>.</p>
    </div>
    
    <div class="test">
        <h2>Fallback Viewer (Object Tag)</h2>
        <div class="pdf-container">
            <object id="fallback-viewer" data="" type="application/pdf" class="pdf-viewer">
                <p>Your browser doesn't support embedded PDFs. <a href="#" id="fallback-download">Download the PDF</a> instead.</p>
            </object>
        </div>
    </div>

    <script>
        // PDF.js configuration
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Environment detection
        const isLocal = window.location.protocol === 'file:';
        const basePath = isLocal ? window.location.href.split('/').slice(0, -1).join('/') : window.location.origin;
        const pdfPath = isLocal ? 'images/inside/window.pdf' : '/images/inside/window.pdf';

        // DOM elements
        const pdfCanvas = document.getElementById('pdf-canvas');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const pageNum = document.getElementById('page-num');
        const pageCount = document.getElementById('page-count');
        const loadingIndicator = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const fallbackViewer = document.getElementById('fallback-viewer');
        const directLink = document.getElementById('direct-link');
        const fallbackDownload = document.getElementById('fallback-download');

        // PDF state
        let pdfDoc = null;
        let pageNumCurrent = 1;
        let pageRendering = false;
        let pageNumPending = null;
        const scale = 1.5;

        // Get the PDF URL with CORS proxy for local files if needed
        function getPdfUrl(path) {
            if (!isLocal) {
                return path.startsWith('http') ? path : `${basePath}${path.startsWith('/') ? '' : '/'}${path}`;
            }
            
            // For local files, try direct access first, then fallback to object URL
            try {
                // Try to create an object URL for local file access
                const fullPath = `${basePath}/${path}`.replace(/([^:]\/)\/+/g, '$1');
                return fullPath;
            } catch (e) {
                console.warn('Direct file access failed, using fallback method');
                return path;
            }
        }

        // Render the page
        async function renderPage(num) {
            pageRendering = true;
            loadingIndicator.style.display = 'flex';
            errorElement.style.display = 'none';
            
            try {
                const page = await pdfDoc.getPage(num);
                const viewport = page.getViewport({ scale });
                
                // Adjust canvas size
                const canvas = pdfCanvas;
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Update page counters
                pageNum.textContent = num;
                pageCount.textContent = pdfDoc.numPages;
                
                // Update button states
                prevButton.disabled = num <= 1;
                nextButton.disabled = num >= pdfDoc.numPages;
                
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                
                // If another page rendering is pending, render that page now
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                
            } catch (error) {
                showError(`Error rendering page: ${error.message}`);
                console.error('Render error:', error);
            }
            
            pageRendering = false;
        }

        // Queue a page rendering
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        // Show previous page
        function onPrevPage() {
            if (pageNumCurrent <= 1) return;
            pageNumCurrent--;
            queueRenderPage(pageNumCurrent);
        }

        // Show next page
        function onNextPage() {
            if (pageNumCurrent >= pdfDoc.numPages) return;
            pageNumCurrent++;
            queueRenderPage(pageNumCurrent);
        }

        // Show error message
        function showError(message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            loadingIndicator.style.display = 'none';
        }

        // Initialize the PDF viewer
        async function initPdfViewer() {
            const pdfUrl = getPdfUrl(pdfPath);
            
            try {
                // Update direct links
                directLink.href = pdfUrl;
                fallbackDownload.href = pdfUrl;
                
                // Initialize fallback viewer
                fallbackViewer.data = pdfUrl;
                
                // Try to load with PDF.js first
                try {
                    const loadingTask = pdfjsLib.getDocument({
                        url: pdfUrl,
                        withCredentials: false,
                        // For local files, we might need to read as array buffer
                        ...(isLocal && {
                            data: await fetchLocalPdf(pdfPath)
                        })
                    });
                    
                    pdfDoc = await loadingTask.promise;
                    
                    // Enable controls
                    prevButton.disabled = false;
                    nextButton.disabled = false;
                    
                    // Render the first page
                    await renderPage(1);
                    
                } catch (error) {
                    console.warn('PDF.js failed, falling back to object tag:', error);
                    // If PDF.js fails, the object tag will handle the fallback
                    showError('Using fallback PDF viewer. Some features may be limited.');
                }
                
            } catch (error) {
                showError(`Error loading PDF: ${error.message}. Make sure the PDF file exists at: ${pdfPath}`);
                console.error('Initialization error:', error);
            }
        }

        // Helper function to fetch local PDF as array buffer
        async function fetchLocalPdf(path) {
            try {
                // For local file access, we need to use a different approach
                if (isLocal) {
                    // Try to fetch using XMLHttpRequest which has better local file support
                    return new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', path, true);
                        xhr.responseType = 'arraybuffer';
                        
                        xhr.onload = function(e) {
                            if (this.status === 200) {
                                resolve(this.response);
                            } else {
                                reject(new Error(`Failed to load PDF: ${this.statusText}`));
                            }
                        };
                        
                        xhr.onerror = function() {
                            reject(new Error('Network error while loading PDF'));
                        };
                        
                        xhr.send();
                    });
                }
                
                // For web server, use fetch
                return fetch(path).then(res => res.arrayBuffer());
            } catch (error) {
                console.error('Error loading PDF:', error);
                throw error;
            }
        }

        // Set up navigation
        prevButton.addEventListener('click', onPrevPage);
        nextButton.addEventListener('click', onNextPage);
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                onPrevPage();
            } else if (e.key === 'ArrowRight') {
                onNextPage();
            }
        });
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (pdfDoc) {
                    renderPage(pageNumCurrent);
                }
            }, 250);
        });

        // Initialize the viewer when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPdfViewer);
        } else {
            initPdfViewer();
        }
    </script>
</body>
</html>
